<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆë²•ì²œìë¬¸: í•œì ìˆ˜ë ¨ì¥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@600;900&family=Nanum+Brush+Script&display=swap" rel="stylesheet">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css" />
    
    <style>
        body { 
            font-family: 'Noto Serif KR', serif; 
            background: #020617; 
            margin: 0; display: flex; align-items: center; justify-content: center; height: 100vh;
            overflow: hidden;
        }

        /* ë©”ì¸ ì½˜ì†”: 2px í…Œë‘ë¦¬ + 8px ê³¡ë¥  */
        #gameConsole {
            width: 720px; height: 405px;
            background: transparent;
            border: none;
            border-radius: 0;
            box-shadow: none;
            position: relative; overflow: hidden; display: flex; flex-direction: column;
        }

        .font-brush { font-family: 'Nanum Brush Script', cursive; }
        .magic-glow { text-shadow: 0 0 20px rgba(251, 191, 36, 1); }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ í†µì¼ */
        .btn-magic { 
            font-family: 'Pretendard', sans-serif;
            font-weight: 600;
            font-size: 1.25rem; 
            background: linear-gradient(to bottom, #d97706, #92400e); 
            border: 2px solid #fef3c7; 
            color: #fef3c7; 
            box-shadow: 0 4px 0 #451a03;
            letter-spacing: -0.01em;
            transition: all 0.1s;
            border-radius: 8px;
        }
        .btn-magic:active { transform: translateY(3px); box-shadow: none; }

        /* ì •ë³´ ì •ë ¬ ë ˆì´ì•„ì›ƒ: 140px ê°„ê²© */
        .info-row { display: flex; align-items: center; margin-bottom: 0.75rem; }
        .info-label { width: 140px; flex-shrink: 0; color: #a8a29e; font-weight: 600; }
        .info-value { font-family: 'Noto Serif KR', serif; font-weight: 900; }

        /* ì¹´ë“œ ë””ìì¸ */
        .card-container { perspective: 800px; }
        .card { position: relative; width: 100%; height: 100%; transition: transform 0.5s; transform-style: preserve-3d; cursor: pointer; }
        .card.flipped { transform: rotateY(180deg); }
        .card.matched { opacity: 0; transform: scale(0.8); transition: all 0.4s; pointer-events: none; }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 8px; border: 2px solid #d97706; display: flex; align-items: center; justify-content: center; }
        .card-front { background: #fffbeb; color: #451a03; transform: rotateY(180deg); flex-direction: column; }
        .card-back { background: #450a0a url('img/card.png') center/cover; }
        .card-back::after { content: 'å°'; font-size: 2rem; color: rgba(251, 191, 36, 0.15); font-weight: 900; }

        /* ë§ˆë ¥ ê²Œì´ì§€ */
        .gauge-wrap { width: 60%; height: 18px; background: #000; border-radius: 10px; border: 2px solid #78350f; overflow: hidden; margin: 2px auto 4px; position: relative; }
        #timeBar { height: 100%; width: 100%; background: linear-gradient(to right, #ef4444, #f59e0b, #fbbf24); transition: width 0.1s linear; }

        /* ëª¨ë‹¬ ë ˆì´ì–´ */
        .inner-modal { position: absolute; inset: 0; z-index: 50; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.3); }
        .scroll-content {
            background: linear-gradient(rgba(20, 15, 10, 0.65), rgba(20, 15, 10, 0.65)), url('img/modal1.png') center/cover;
            border: 2px solid #78350f;
            border-radius: 8px;
            padding: 2rem;
            width: 380px;
            text-align: center;
            box-shadow: 0 0 50px #000;
        }
        .title-magic { font-size: 2.25rem; font-weight: 900; margin-bottom: 1.5rem; color: #f59e0b; font-family: 'Nanum Brush Script', cursive; text-shadow: 0 0 20px rgba(251, 191, 36, 1); }
    </style>
</head>
<body>

    <div id="gameConsole">
        
        <div id="magicOverlay" class="fixed inset-0 flex flex-col items-center justify-center text-yellow-400 font-brush font-black opacity-0 pointer-events-none z-[100] transition-opacity duration-300">
            <div id="magicChar" class="text-[12rem] leading-none magic-glow"></div>
            <div id="magicDesc" class="text-4xl mt-4 bg-black/80 px-8 py-2 rounded-full border-2 border-orange-500"></div>
        </div>

        <div id="lobbyArea" class="inner-modal">
            <div class="scroll-content">
                <h2 class="title-magic">ìˆ˜ë ¨ ëŒ€ê¸°ì‹¤</h2>
                <div class="text-lg bg-stone-950 p-6 border border-orange-950 text-left font-bold rounded-lg mb-8">
                    <div class="info-row">
                        <span class="info-label">ğŸ‘¤ ìˆ˜ë ¨ìƒ</span>
                        <span id="lobbyUserName" class="text-yellow-400">ìˆ˜ë ¨ ëŒ€ì›</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ğŸ’ ëˆ„ì  ë§ˆë ¥</span>
                        <span id="lobbyUserScore" class="text-orange-400">0</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ğŸ† ìµœê³  ë‹¨ê³„</span>
                        <span id="lobbyUserLevel" class="text-red-500">Stage 1</span>
                    </div>
                </div>
                <button onclick="startGame()" class="btn-magic w-full py-3">ìˆ˜ë ¨ ì‹œì‘!</button>
            </div>
        </div>

        <div id="playArea" class="hidden flex flex-col h-full">
            <header class="flex justify-between items-center px-5 py-1 bg-black/30 border-b border-orange-900/30">
                <div class="text-3xl font-black text-orange-400 font-brush magic-glow">Stage <span id="curStage">1</span></div>
                <div id="comboShow" class="text-2xl font-black text-blue-400 font-brush"></div>
            </header>
            <div class="flex items-center justify-between px-5 pt-1 pb-1">
                <div class="gauge-wrap"><div id="timeBar"></div></div>
                <div class="text-base font-bold text-yellow-400 ml-3 shrink-0">ë§ˆë ¥: <span id="curScore">0</span></div>
            </div>
            <div id="gridArea" class="flex-1 overflow-auto p-1 flex items-start justify-center">
                <div id="cardGrid" class="grid gap-4 grid-cols-2"></div>
            </div>
        </div>

        <div id="resArea" class="inner-modal hidden">
            <div class="scroll-content">
                <h2 class="title-magic">ìˆ˜ë ¨ ì¢…ë£Œ</h2>
                <div class="text-xl bg-stone-950 p-6 border border-orange-950 text-left font-bold rounded-lg mb-8">
                    <div class="info-row">
                        <span class="info-label">ğŸ’ ì–»ì€ ë§ˆë ¥</span>
                        <span id="resScore" class="info-value text-orange-400">0</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ğŸ† ë„ë‹¬ ë‹¨ê³„</span>
                        <span id="resStage" class="info-value text-red-500">Stage 1</span>
                    </div>
                </div>
                <button onclick="finishGame()" class="btn-magic w-full py-3">ê¸°ë¡ ì €ì¥</button>
            </div>
        </div>

    </div>

    <script>
        const hanjas = [
            {id:1, c:"å¤§", m:"í¬ë‹¤", s:"ëŒ€"}, {id:2, c:"å°", m:"ì‘ë‹¤", s:"ì†Œ"},
            {id:3, c:"æ—¥", m:"ë‚ ", s:"ì¼"}, {id:4, c:"æœˆ", m:"ë‹¬", s:"ì›”"},
            {id:5, c:"å±±", m:"ì‚°", s:"ì‚°"}, {id:6, c:"æ°´", m:"ë¬¼", s:"ìˆ˜"},
            {id:7, c:"ç«", m:"ë¶ˆ", s:"í™”"}, {id:8, c:"æœ¨", m:"ë‚˜ë¬´", s:"ëª©"},
            {id:9, c:"é‡‘", m:"ì‡ ", s:"ê¸ˆ"}, {id:10, c:"åœŸ", m:"í™", s:"í† "},
            {id:11, c:"å¤©", m:"í•˜ëŠ˜", s:"ì²œ"}, {id:12, c:"åœ°", m:"ë•…", s:"ì§€"}
        ];

        let stage=1, total=0, stageS=0, rem=0, active=false, timer=null;
        let flipC=[], matchC=0, combo=0;
        let userId = 'guest';
        let storageKey = 'hanjaGameData:guest';

        // ë¡œë“œ ì‹œ ì´ˆê¸° ë°ì´í„° (ì›ë˜ëŠ” ë¶€ëª¨ ê²Œì„ì—ì„œ ë°›ì•„ì˜¤ë©´ ì¢‹ìŠµë‹ˆë‹¤)
        function applyUser(id) {
            userId = id || 'guest';
            storageKey = `hanjaGameData:${userId}`;
            document.getElementById('lobbyUserName').innerText = userId;
            const data = JSON.parse(localStorage.getItem(storageKey) || '{"score":0, "level":1}');
            total = data.score || 0;
            stage = data.level || 1;
            document.getElementById('lobbyUserScore').innerText = total;
            document.getElementById('lobbyUserLevel').innerText = `Stage ${stage}`;
        }

        window.addEventListener('message', (event) => {
            const data = event.data || {};
            if (data.type === 'hanjaUser') {
                applyUser(data.id);
            }
        });

        window.onload = () => {
            applyUser(userId);
            window.parent.postMessage({ type: 'hanjaReady' }, '*');
            speak("ìˆ˜ë ¨ì¥ì— ì˜ ì™”ë‹¤! ì¤€ë¹„ëìœ¼ë©´ ì‹œì‘í•´ë³¼ê¹Œ?");
        };

        function startGame() {
            document.getElementById('lobbyArea').classList.add('hidden');
            document.getElementById('playArea').classList.remove('hidden');
            stageS = 0; stage = 1; initStage();
        }


        function initStage() {
            active = true; flipC = []; matchC = 0; combo = 0;
            document.getElementById('curStage').innerText = stage;
            document.getElementById('curScore').innerText = total + stageS;

            let r, c, sz, fz;
            if(stage===1) { r=2; c=2; sz="w-24 h-32"; fz="text-5xl"; }
            else if(stage===2) { r=2; c=3; sz="w-20 h-28"; fz="text-4xl"; }
            else if(stage===3) { r=2; c=4; sz="w-16 h-24"; fz="text-3xl"; }
            else { r=4; c=4; sz="w-14 h-20"; fz="text-2xl"; }

            const pairs = (r * c) / 2;
            const shuffled = [...hanjas].sort(() => Math.random() - 0.5).slice(0, pairs);
            let cards = [];
            shuffled.forEach(h => {
                cards.push({...h, type:'c', t: h.c});
                cards.push({...h, type:'s', t: `${h.m}\n[${h.s}]`});
            });
            cards.sort(() => Math.random() - 0.5);

            const grid = document.getElementById('cardGrid');
            grid.innerHTML = ""; grid.className = `grid gap-4 grid-cols-${c}`;

            cards.forEach(d => {
                const div = document.createElement('div');
                div.className = `card-container ${sz}`;
                div.innerHTML = `
                    <div class="card" data-id="${d.id}" data-type="${d.type}">
                        <div class="card-front"><div class="text-center font-black ${d.type==='c'?fz:'text-xl whitespace-pre-line'}">${d.t}</div></div>
                        <div class="card-back"></div>
                    </div>`;
                div.onclick = () => flip(div.querySelector('.card'), d);
                grid.appendChild(div);
            });

            rem = pairs * 10;
            if(timer) clearInterval(timer);
            const tot = rem;
            timer = setInterval(() => {
                rem -= 0.1;
                document.getElementById('timeBar').style.width = (rem/tot*100)+'%';
                if(rem <= 0) endGame();
            }, 100);
        }

        function flip(el, d) {
            if(!active || flipC.length >= 2 || el.classList.contains('flipped') || el.classList.contains('matched')) return;
            el.classList.add('flipped');
            flipC.push({el, d});
            if(flipC.length === 2) check();
        }

        function check() {
            const [a, b] = flipC;
            if(a.d.id === b.d.id && a.d.type !== b.d.type) {
                stageS += 10; matchC += 2; combo++;
                rem = Math.min(rem + 3, 150);
                showMagic(a.d);
                if(combo >= 3) triggerHint();
                setTimeout(() => {
                    a.el.classList.add('matched'); b.el.classList.add('matched');
                    flipC = [];
                    if(matchC === document.querySelectorAll('.card').length) {
                        stage++; clearInterval(timer);
                        setTimeout(initStage, 600);
                    }
                }, 600);
            } else {
                combo = 0; rem -= 2;
                document.getElementById('comboShow').innerText = "";
                setTimeout(() => {
                    a.el.classList.remove('flipped'); b.el.classList.remove('flipped');
                    flipC = [];
                }, 600);
            }
        }

        function triggerHint() {
            document.getElementById('comboShow').innerText = `${combo} ì½¤ë³´!`;
            speak("íŒíŠ¸ ë§ˆë²•!");
            const target = Array.from(document.querySelectorAll('.card:not(.matched):not(.flipped)'));
            if(target.length >= 2) {
                const id = target[0].dataset.id;
                const pair = target.filter(c => c.dataset.id === id);
                pair.forEach(c => c.classList.add('flipped'));
                setTimeout(() => pair.forEach(c => { if(!c.classList.contains('matched')) c.classList.remove('flipped'); }), 600);
            }
        }

        function showMagic(d) {
            const o = document.getElementById('magicOverlay');
            document.getElementById('magicChar').innerText = d.c;
            document.getElementById('magicDesc').innerText = `${d.m} ${d.s}`;
            o.style.opacity = "1"; speak(`${d.m} ${d.s}`);
            setTimeout(() => o.style.opacity = "0", 700);
        }

        function endGame() {
            active = false; clearInterval(timer);
            speak("ìˆ˜ë ¨ ì‹œê°„ì´ ëë‚¬ë‹¤!");
            document.getElementById('resScore').innerText = stageS;
            document.getElementById('resStage').innerText = `Stage ${stage}`;
            document.getElementById('resArea').classList.remove('hidden');
            document.getElementById('playArea').classList.add('hidden');
        }

        function finishGame() {
            total += stageS;
            localStorage.setItem(storageKey, JSON.stringify({score: total, level: stage}));
            location.reload();
        }

        function speak(t) { window.speechSynthesis.cancel(); const m = new SpeechSynthesisUtterance(t); m.lang = 'ko-KR'; m.rate = 1.2; window.speechSynthesis.speak(m); }
    </script>
</body>
</html>
