<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆë²•ì²œìë¬¸: í•œì ìˆ˜ë ¨ì¥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@600;900&family=Nanum+Brush+Script&display=swap" rel="stylesheet">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css" />
    
    <style>
        body { 
            font-family: 'Noto Serif KR', serif; 
            background: #020617; 
            margin: 0; display: flex; align-items: center; justify-content: center; height: 100vh;
            overflow: hidden;
        }

        /* ë©”ì¸ ì½˜ì†”: 2px í…Œë‘ë¦¬ + 8px ê³¡ë¥  */
        #gameConsole {
            width: 720px; height: 405px;
            background: transparent;
            border: none;
            border-radius: 0;
            box-shadow: none;
            position: relative; overflow: hidden; display: flex; flex-direction: column;
        }

        .font-brush { font-family: 'Nanum Brush Script', cursive; }
        .magic-glow { text-shadow: 0 0 20px rgba(251, 191, 36, 1); }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ í†µì¼ */
        .btn-magic { 
            font-family: 'Pretendard', sans-serif;
            font-weight: 600;
            font-size: 1.25rem; 
            background: linear-gradient(to bottom, #d97706, #92400e); 
            border: 2px solid #fef3c7; 
            color: #fef3c7; 
            box-shadow: 0 4px 0 #451a03;
            letter-spacing: -0.01em;
            transition: all 0.1s;
            border-radius: 8px;
        }
        .btn-magic:active { transform: translateY(3px); box-shadow: none; }

        /* ì •ë³´ ì •ë ¬ ë ˆì´ì•„ì›ƒ: 140px ê°„ê²© */
        .info-row { display: flex; align-items: center; margin-bottom: 0.75rem; }
        .info-label { width: 140px; flex-shrink: 0; color: #a8a29e; font-weight: 600; }
        .info-value { font-family: 'Noto Serif KR', serif; font-weight: 900; }

        /* ì¹´ë“œ ë””ìì¸ */
        .card-grid {
            --card-w: 80px;
            --card-h: 110px;
            --card-font: 28px;
            --card-font-sub: 18px;
        }
        .card-container { width: var(--card-w); height: var(--card-h); perspective: 800px; }
        .card { position: relative; width: 100%; height: 100%; transition: transform 0.5s; transform-style: preserve-3d; cursor: pointer; }
        .card.flipped { transform: rotateY(180deg); }
        .card.matched { opacity: 0; transform: scale(0.8); transition: all 0.4s; pointer-events: none; }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 8px; border: 2px solid #d97706; display: flex; align-items: center; justify-content: center; }
        .card-front { background: #fffbeb; color: #451a03; transform: rotateY(180deg); flex-direction: column; }
        .card-back { background: #450a0a url('img/card.png') center/cover; }
        .card-back::after { content: 'å°'; font-size: 2rem; color: rgba(251, 191, 36, 0.15); font-weight: 900; }
        .hanja-char { font-size: var(--card-font); }
        .hanja-meaning { font-size: var(--card-font-sub); }

        /* ë§ˆë ¥ ê²Œì´ì§€ */
        .gauge-wrap { width: 60%; height: 18px; background: #000; border-radius: 10px; border: 2px solid #78350f; overflow: hidden; margin: 2px auto 4px; position: relative; }
        #timeBar { height: 100%; width: 100%; background: linear-gradient(to right, #ef4444, #f59e0b, #fbbf24); transition: width 0.1s linear; }

        /* ëª¨ë‹¬ ë ˆì´ì–´ */
        .inner-modal { position: absolute; inset: 0; z-index: 50; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.3); }
        .scroll-content {
            background: linear-gradient(rgba(20, 15, 10, 0.65), rgba(20, 15, 10, 0.65)), url('img/modal1.png') center/cover;
            border: 2px solid #78350f;
            border-radius: 8px;
            padding: 1.5rem;
            width: 380px;
            text-align: center;
            box-shadow: 0 0 50px #000;
        }
        .title-magic { font-size: 2.25rem; font-weight: 900; margin-bottom: 1rem; color: #f59e0b; font-family: 'Nanum Brush Script', cursive; text-shadow: 0 0 20px rgba(251, 191, 36, 1); }
    </style>
</head>
<body>

    <div id="gameConsole">
        
        <div id="magicOverlay" class="fixed inset-0 flex flex-col items-center justify-center text-yellow-400 font-brush font-black opacity-0 pointer-events-none z-[100] transition-opacity duration-300">
            <div id="magicChar" class="text-[12rem] leading-none magic-glow"></div>
            <div id="magicDesc" class="text-4xl mt-4 bg-black/80 px-8 py-2 rounded-full border-2 border-orange-500"></div>
        </div>

        <div id="lobbyArea" class="inner-modal">
            <div class="scroll-content">
                <h2 class="title-magic">ìˆ˜ë ¨ ëŒ€ê¸°ì‹¤</h2>
                <div class="text-lg bg-stone-950 p-4 border border-orange-950 text-left font-bold rounded-lg mb-4">
                    <div class="info-row">
                        <span class="info-label">ğŸ‘¤ ìˆ˜ë ¨ìƒ</span>
                        <span id="lobbyUserName" class="text-yellow-400">ìˆ˜ë ¨ ëŒ€ì›</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ğŸ’ ëˆ„ì  ë§ˆë ¥</span>
                        <span id="lobbyUserScore" class="text-orange-400">0</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ğŸ† ìµœê³  ë‹¨ê³„</span>
                        <span id="lobbyUserLevel" class="text-red-500">Stage 1</span>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="startGame(false)" class="btn-magic flex-1 py-3">
                        ì´ì–´í•˜ê¸° <span id="continueStageLabel" class="text-sm">(Stage 1)</span>
                    </button>
                    <button onclick="startGame(true)" class="btn-magic flex-1 py-3 opacity-80">
                        ì²˜ìŒë¶€í„°
                    </button>
                </div>
            </div>
        </div>

        <div id="playArea" class="hidden flex flex-col h-full">
            <header class="flex justify-between items-center px-5 py-1 bg-black/30 border-b border-orange-900/30">
                <div class="text-3xl font-black text-orange-400 font-brush magic-glow">Stage <span id="curStage">1</span></div>
                <div id="comboShow" class="text-2xl font-black text-blue-400 font-brush"></div>
            </header>
            <div class="flex items-center justify-between px-5 pt-1 pb-1">
                <div class="gauge-wrap"><div id="timeBar"></div></div>
                <div class="text-base font-bold text-yellow-400 ml-3 shrink-0">ë§ˆë ¥: <span id="curScore">0</span></div>
            </div>
            <div id="gridArea" class="flex-1 overflow-auto p-1 flex items-start justify-center">
                <div id="cardGrid" class="grid gap-4 grid-cols-2 mx-auto"></div>
            </div>
        </div>

        <div id="resArea" class="inner-modal hidden">
            <div class="scroll-content">
                <h2 class="title-magic">ìˆ˜ë ¨ ì¢…ë£Œ</h2>
                <div class="text-xl bg-stone-950 p-6 border border-orange-950 text-left font-bold rounded-lg mb-8">
                    <div class="info-row">
                        <span class="info-label">ğŸ’ ì–»ì€ ë§ˆë ¥</span>
                        <span id="resScore" class="info-value text-orange-400">0</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ğŸ† ë„ë‹¬ ë‹¨ê³„</span>
                        <span id="resStage" class="info-value text-red-500">Stage 1</span>
                    </div>
                </div>
                <button onclick="finishGame()" class="btn-magic w-full py-3">ê¸°ë¡ ì €ì¥</button>
            </div>
        </div>

    </div>

    <script>
        // í…Œë§ˆë³„ ê·¸ë£¹í•‘: ìˆ«ì â†’ ìš”ì¼/ì˜¤í–‰ â†’ ê¸°ë³¸í˜•íƒœ â†’ ë°©í–¥ â†’ ì‚¬ëŒ/ê°€ì¡± â†’ ì‚¬íšŒ â†’ ê¸°íƒ€
        const hanjas = [
            // 1-10: ìˆ«ì
            {id:1, c:"ä¸€", m:"í•œ", s:"ì¼"},
            {id:2, c:"äºŒ", m:"ë‘", s:"ì´"},
            {id:3, c:"ä¸‰", m:"ì„", s:"ì‚¼"},
            {id:4, c:"å››", m:"ë„‰", s:"ì‚¬"},
            {id:5, c:"äº”", m:"ë‹¤ì„¯", s:"ì˜¤"},
            {id:6, c:"å…­", m:"ì—¬ì„¯", s:"ìœ¡"},
            {id:7, c:"ä¸ƒ", m:"ì¼ê³±", s:"ì¹ "},
            {id:8, c:"å…«", m:"ì—¬ëŸ", s:"íŒ”"},
            {id:9, c:"ä¹", m:"ì•„í™‰", s:"êµ¬"},
            {id:10, c:"å", m:"ì—´", s:"ì‹­"},
            // 11-17: ìš”ì¼/ì˜¤í–‰
            {id:11, c:"æ—¥", m:"ë‚ ", s:"ì¼"},
            {id:12, c:"æœˆ", m:"ë‹¬", s:"ì›”"},
            {id:13, c:"ç«", m:"ë¶ˆ", s:"í™”"},
            {id:14, c:"æ°´", m:"ë¬¼", s:"ìˆ˜"},
            {id:15, c:"æœ¨", m:"ë‚˜ë¬´", s:"ëª©"},
            {id:16, c:"é‡‘", m:"ì‡ ", s:"ê¸ˆ"},
            {id:17, c:"åœŸ", m:"í™", s:"í† "},
            // 18-23: ê¸°ë³¸ í˜•íƒœ
            {id:18, c:"å¤§", m:"í°", s:"ëŒ€"},
            {id:19, c:"å°", m:"ì‘ì„", s:"ì†Œ"},
            {id:20, c:"ä¸­", m:"ê°€ìš´ë°", s:"ì¤‘"},
            {id:21, c:"é•·", m:"ê¸¸", s:"ì¥"},
            {id:22, c:"å±±", m:"ë«¼", s:"ì‚°"},
            {id:23, c:"é–€", m:"ë¬¸", s:"ë¬¸"},
            // 24-29: ë°©í–¥
            {id:24, c:"æ±", m:"ë™ë…˜", s:"ë™"},
            {id:25, c:"è¥¿", m:"ì„œë…˜", s:"ì„œ"},
            {id:26, c:"å—", m:"ë‚¨ë…˜", s:"ë‚¨"},
            {id:27, c:"åŒ—", m:"ë¶ë…˜", s:"ë¶"},
            {id:28, c:"å¤–", m:"ë°”ê¹¥", s:"ì™¸"},
            {id:29, c:"å®¤", m:"ì§‘", s:"ì‹¤"},
            // 30-35: ì‚¬ëŒ/ê°€ì¡±
            {id:30, c:"äºº", m:"ì‚¬ëŒ", s:"ì¸"},
            {id:31, c:"å¥³", m:"ì—¬ì", s:"ë…€"},
            {id:32, c:"çˆ¶", m:"ì•„ë²„ì§€", s:"ë¶€"},
            {id:33, c:"æ¯", m:"ì–´ë¨¸ë‹ˆ", s:"ëª¨"},
            {id:34, c:"å…„", m:"í˜•", s:"í˜•"},
            {id:35, c:"å¼Ÿ", m:"ì•„ìš°", s:"ì œ"},
            // 36-43: ì‚¬íšŒ
            {id:36, c:"ç‹", m:"ì„ê¸ˆ", s:"ì™•"},
            {id:37, c:"æ°‘", m:"ë°±ì„±", s:"ë¯¼"},
            {id:38, c:"è»", m:"êµ°ì‚¬", s:"êµ°"},
            {id:39, c:"åœ‹", m:"ë‚˜ë¼", s:"êµ­"},
            {id:40, c:"æ ¡", m:"í•™êµ", s:"êµ"},
            {id:41, c:"å­¸", m:"ë°°ìš¸", s:"í•™"},
            {id:42, c:"æ•", m:"ê°€ë¥´ì¹ ", s:"êµ"},
            {id:43, c:"ç”Ÿ", m:"ë‚ ", s:"ìƒ"},
            // 44-50: ê¸°íƒ€
            {id:44, c:"ç™½", m:"í°", s:"ë°±"},
            {id:45, c:"é‘", m:"í‘¸ë¥¼", s:"ì²­"},
            {id:46, c:"å¹´", m:"í•´", s:"ë…„"},
            {id:47, c:"å…ˆ", m:"ë¨¼ì €", s:"ì„ "},
            {id:48, c:"è¬", m:"ì¼ë§Œ", s:"ë§Œ"},
            {id:49, c:"å¯¸", m:"ë§ˆë””", s:"ì´Œ"},
            {id:50, c:"éŸ“", m:"ë‚˜ë¼ì´ë¦„", s:"í•œ"}
        ];

        // ì ì§„ì  ì¦ê°€: ì¹´ë“œ ìˆ˜ í•­ìƒ ì¦ê°€/ìœ ì§€, ìµœëŒ€ 48ì¥ (6x8)
        const stageLayouts = [
            { r: 2, c: 2 },  // Stage 1:  4ì¥
            { r: 2, c: 3 },  // Stage 2:  6ì¥
            { r: 2, c: 4 },  // Stage 3:  8ì¥
            { r: 3, c: 4 },  // Stage 4:  12ì¥
            { r: 4, c: 4 },  // Stage 5:  16ì¥
            { r: 4, c: 5 },  // Stage 6:  20ì¥
            { r: 4, c: 6 },  // Stage 7:  24ì¥
            { r: 5, c: 6 },  // Stage 8:  30ì¥
            { r: 6, c: 6 },  // Stage 9:  36ì¥
            { r: 6, c: 7 },  // Stage 10: 42ì¥
            { r: 6, c: 8 },  // Stage 11: 48ì¥
            { r: 6, c: 8 },  // Stage 12: 48ì¥ (ë‚œì´ë„ëŠ” ì‹œê°„ìœ¼ë¡œ)
        ];

        let stage=1, total=0, stageS=0, rem=0, active=false, timer=null;
        let flipC=[], matchC=0, combo=0;
        let userId = 'guest';
        let storageKey = 'hanjaGameData:guest';

        function loadProgress() {
            return JSON.parse(localStorage.getItem(storageKey) || '{"score":0, "level":1}');
        }

        function saveProgress(nextLevel) {
            const level = Math.min(Math.max(1, nextLevel), stageLayouts.length);
            localStorage.setItem(storageKey, JSON.stringify({score: total + stageS, level}));
        }

        // ë¡œë“œ ì‹œ ì´ˆê¸° ë°ì´í„° (ì›ë˜ëŠ” ë¶€ëª¨ ê²Œì„ì—ì„œ ë°›ì•„ì˜¤ë©´ ì¢‹ìŠµë‹ˆë‹¤)
        function applyUser(id) {
            userId = id || 'guest';
            storageKey = `hanjaGameData:${userId}`;
            document.getElementById('lobbyUserName').innerText = userId;
            const data = loadProgress();
            total = data.score || 0;
            stage = data.level || 1;
            document.getElementById('lobbyUserScore').innerText = total;
            document.getElementById('lobbyUserLevel').innerText = `Stage ${stage}`;
            document.getElementById('continueStageLabel').innerText = `(Stage ${stage})`;
        }

        window.addEventListener('message', (event) => {
            const data = event.data || {};
            if (data.type === 'hanjaUser') {
                applyUser(data.id);
            }
        });

        window.onload = () => {
            applyUser(userId);
            window.parent.postMessage({ type: 'hanjaReady' }, '*');
            speak("ìˆ˜ë ¨ì¥ì— ì˜ ì™”ë‹¤! ì¤€ë¹„ëìœ¼ë©´ ì‹œì‘í•´ë³¼ê¹Œ?");
        };

        function updateScore() {
            document.getElementById('curScore').innerText = total + stageS;
        }

        function startGame(fromBeginning = false) {
            if (fromBeginning) {
                stage = 1;
            }
            document.getElementById('lobbyArea').classList.add('hidden');
            document.getElementById('playArea').classList.remove('hidden');
            stageS = 0;
            initStage();
        }


        function initStage() {
            active = true; flipC = []; matchC = 0; combo = 0;
            document.getElementById('curStage').innerText = stage;
            updateScore();

            if (stage > stageLayouts.length) {
                endGame();
                return;
            }

            const layout = stageLayouts[stage - 1];
            const r = layout.r;
            const c = layout.c;

            const pairs = (r * c) / 2;

            // ë” ë¹ ë¥¸ í•´ê¸ˆ: Stage 12ì—ì„œ ì „ì²´ 50ê°œ í•´ê¸ˆ
            const progress = Math.min(1, (stage + 5) / 16);
            const unlockCount = Math.max(
                pairs,
                Math.ceil(progress * hanjas.length)
            );
            const pool = hanjas.slice(0, unlockCount);
            const shuffled = [...pool].sort(() => Math.random() - 0.5).slice(0, pairs);
            let cards = [];
            shuffled.forEach(h => {
                cards.push({...h, type:'c', t: h.c});
                cards.push({...h, type:'s', t: `${h.m}\n[${h.s}]`});
            });
            cards.sort(() => Math.random() - 0.5);

            const grid = document.getElementById('cardGrid');
            grid.innerHTML = "";
            grid.className = "card-grid grid gap-4 mx-auto";
            grid.style.gridTemplateColumns = `repeat(${c}, minmax(0, 1fr))`;

            const gridArea = document.getElementById('gridArea');
            const gap = 16;
            const availableWidth = Math.max(240, gridArea.clientWidth - 8);
            const availableHeight = Math.max(180, gridArea.clientHeight - 8);
            const maxWidth = (availableWidth - gap * (c - 1)) / c;
            const maxHeight = (availableHeight - gap * (r - 1)) / r;
            const widthFromHeight = maxHeight / 1.3;
            const cardW = Math.max(40, Math.min(maxWidth, widthFromHeight));
            const cardH = cardW * 1.3;
            const charFont = Math.max(18, Math.min(64, cardW * 0.6));
            const meaningFont = Math.max(12, Math.min(28, cardW * 0.28));
            grid.style.setProperty('--card-w', `${cardW}px`);
            grid.style.setProperty('--card-h', `${cardH}px`);
            grid.style.setProperty('--card-font', `${charFont}px`);
            grid.style.setProperty('--card-font-sub', `${meaningFont}px`);

            cards.forEach(d => {
                const div = document.createElement('div');
                div.className = "card-container";
                div.innerHTML = `
                    <div class="card" data-id="${d.id}" data-type="${d.type}">
                        <div class="card-front"><div class="text-center font-black ${d.type==='c'?'hanja-char':'hanja-meaning whitespace-pre-line'}">${d.t}</div></div>
                        <div class="card-back"></div>
                    </div>`;
                div.onclick = () => flip(div.querySelector('.card'), d);
                grid.appendChild(div);
            });

            rem = pairs * 10;
            if(timer) clearInterval(timer);
            const tot = rem;
            timer = setInterval(() => {
                rem -= 0.1;
                document.getElementById('timeBar').style.width = (rem/tot*100)+'%';
                if(rem <= 0) endGame();
            }, 100);
        }

        function flip(el, d) {
            if(!active || flipC.length >= 2 || el.classList.contains('flipped') || el.classList.contains('matched')) return;
            el.classList.add('flipped');
            flipC.push({el, d});
            if(flipC.length === 2) check();
        }

        function check() {
            const [a, b] = flipC;
            if(a.d.id === b.d.id && a.d.type !== b.d.type) {
                stageS += 10; matchC += 2; combo++;
                updateScore();
                rem = Math.min(rem + 3, 150);
                showMagic(a.d);
                if(combo >= 3) triggerHint();
                setTimeout(() => {
                    a.el.classList.add('matched'); b.el.classList.add('matched');
                    flipC = [];
                    if(matchC === document.querySelectorAll('.card').length) {
                        clearInterval(timer);
                        if (stage >= stageLayouts.length) {
                            saveProgress(stage);
                            endGame();
                        } else {
                            saveProgress(stage + 1);
                            stage++;
                            setTimeout(initStage, 600);
                        }
                    }
                }, 600);
            } else {
                combo = 0; rem -= 2;
                document.getElementById('comboShow').innerText = "";
                setTimeout(() => {
                    a.el.classList.remove('flipped'); b.el.classList.remove('flipped');
                    flipC = [];
                }, 600);
            }
        }

        function triggerHint() {
            document.getElementById('comboShow').innerText = `${combo} ì½¤ë³´!`;
            speak("íŒíŠ¸ ë§ˆë²•!");
            const target = Array.from(document.querySelectorAll('.card:not(.matched):not(.flipped)'));
            if(target.length >= 2) {
                const id = target[0].dataset.id;
                const pair = target.filter(c => c.dataset.id === id);
                pair.forEach(c => c.classList.add('flipped'));
                setTimeout(() => pair.forEach(c => { if(!c.classList.contains('matched')) c.classList.remove('flipped'); }), 600);
            }
        }

        function showMagic(d) {
            const o = document.getElementById('magicOverlay');
            document.getElementById('magicChar').innerText = d.c;
            document.getElementById('magicDesc').innerText = `${d.m} ${d.s}`;
            o.style.opacity = "1"; speak(`${d.m} ${d.s}`);
            setTimeout(() => o.style.opacity = "0", 700);
        }

        function endGame() {
            active = false; clearInterval(timer);
            speak("ìˆ˜ë ¨ ì‹œê°„ì´ ëë‚¬ë‹¤!");
            document.getElementById('resScore').innerText = stageS;
            document.getElementById('resStage').innerText = `Stage ${stage}`;
            document.getElementById('resArea').classList.remove('hidden');
            document.getElementById('playArea').classList.add('hidden');
        }

        function finishGame() {
            total += stageS;
            localStorage.setItem(storageKey, JSON.stringify({score: total, level: stage}));
            location.reload();
        }

        function speak(t) { window.speechSynthesis.cancel(); const m = new SpeechSynthesisUtterance(t); m.lang = 'ko-KR'; m.rate = 1.2; window.speechSynthesis.speak(m); }
    </script>
</body>
</html>
