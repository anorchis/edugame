<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ìˆ˜ë ¨ì¥ 1: í•œì ì¹´ë“œ (ëª¨ë°”ì¼)</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Brush+Script&family=Noto+Sans+KR:wght@400;700;900&family=Noto+Serif+KR:wght@600;900&display=swap" rel="stylesheet">

    <!-- Common Mobile Styles -->
    <link rel="stylesheet" href="common.css">

    <style>
        body {
            background: #020617;
            font-family: 'Noto Serif KR', serif;
        }

        /* ì „ì²´ ë ˆì´ì•„ì›ƒ */
        .game-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* ìƒë‹¨ í—¤ë” */
        .game-header {
            padding: 12px 16px;
            padding-top: calc(12px + env(safe-area-inset-top, 0));
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        .back-button {
            width: 44px;
            height: 44px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            color: #fff;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stage-title {
            font-family: 'Nanum Brush Script', cursive;
            font-size: 28px;
            color: #f59e0b;
            text-shadow: 0 0 20px rgba(251, 191, 36, 0.6);
        }

        .score-display {
            font-size: 14px;
            color: #fbbf24;
            font-weight: 700;
        }

        /* ë§ˆë ¥ ê²Œì´ì§€ */
        .gauge-container {
            padding: 0 16px;
            margin-top: calc(68px + env(safe-area-inset-top, 0));
        }

        .gauge-wrap {
            width: 100%;
            height: 12px;
            background: #1f1f1f;
            border-radius: 6px;
            border: 2px solid #78350f;
            overflow: hidden;
        }

        .gauge-fill {
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, #ef4444, #f59e0b, #fbbf24);
            transition: width 0.1s linear;
            border-radius: 4px;
        }

        /* ì½¤ë³´ í‘œì‹œ */
        .combo-display {
            text-align: center;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .combo-text {
            font-family: 'Nanum Brush Script', cursive;
            font-size: 24px;
            color: #3b82f6;
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.6);
        }

        /* ì¹´ë“œ ê·¸ë¦¬ë“œ ì˜ì—­ */
        .grid-area {
            flex: 1;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
        }

        .card-grid {
            display: grid;
            gap: 8px;
            grid-template-columns: repeat(4, 1fr);
            width: 100%;
            max-width: 400px;
            align-content: start;
        }

        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card-container {
            aspect-ratio: 3 / 4;
            perspective: 800px;
        }

        .card {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.4s ease-out;
            transform-style: preserve-3d;
            cursor: pointer;
        }

        .card.flipped {
            transform: rotateY(180deg);
        }

        .card.matched {
            opacity: 0;
            transform: scale(0.8) rotateY(180deg);
            transition: all 0.4s ease-out;
            pointer-events: none;
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 12px;
            border: 2px solid #d97706;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .card-front {
            background: linear-gradient(180deg, #fffbeb 0%, #fef3c7 100%);
            color: #451a03;
            transform: rotateY(180deg);
            flex-direction: column;
            padding: 4px;
        }

        .card-back {
            background: linear-gradient(180deg, #450a0a 0%, #1c0a0a 100%);
            background-image: url('../img/card.png');
            background-size: cover;
            background-position: center;
        }

        .card-back::after {
            content: 'å°';
            font-size: clamp(24px, 8vw, 48px);
            color: rgba(251, 191, 36, 0.15);
            font-weight: 900;
        }

        .hanja-char {
            font-size: clamp(24px, 10vw, 48px);
            font-weight: 900;
            line-height: 1;
        }

        .hanja-meaning {
            font-size: clamp(12px, 4vw, 18px);
            font-weight: 700;
            text-align: center;
            white-space: pre-line;
            line-height: 1.2;
        }

        /* ë§ˆë²• ì˜¤ë²„ë ˆì´ */
        .magic-overlay {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.8);
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .magic-overlay.active {
            opacity: 1;
        }

        .magic-char {
            font-family: 'Nanum Brush Script', cursive;
            font-size: 120px;
            color: #fbbf24;
            text-shadow: 0 0 40px rgba(251, 191, 36, 1);
            line-height: 1;
        }

        .magic-desc {
            font-size: 28px;
            color: #fff;
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 24px;
            border-radius: 24px;
            border: 2px solid #f59e0b;
            margin-top: 16px;
        }

        /* ë¡œë¹„ í™”ë©´ */
        .lobby-screen {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 300;
            padding: 24px;
        }

        .lobby-screen.hidden {
            display: none;
        }

        .lobby-content {
            background: linear-gradient(180deg, rgba(20, 15, 10, 0.9), rgba(20, 15, 10, 0.95)),
                        url('../img/modal1.png') center/cover;
            border: 2px solid #78350f;
            border-radius: 20px;
            padding: 24px;
            width: 100%;
            max-width: 360px;
            text-align: center;
        }

        .lobby-title {
            font-family: 'Nanum Brush Script', cursive;
            font-size: 36px;
            color: #f59e0b;
            text-shadow: 0 0 20px rgba(251, 191, 36, 1);
            margin-bottom: 20px;
        }

        .lobby-info {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #78350f;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            text-align: left;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(120, 53, 15, 0.3);
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: #a8a29e;
            font-weight: 600;
        }

        .info-value {
            font-weight: 900;
        }

        .lobby-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .lobby-btn {
            width: 100%;
            padding: 16px;
            font-size: 18px;
            font-weight: 700;
            border-radius: 12px;
            border: 2px solid #fef3c7;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .lobby-btn:active {
            transform: translateY(4px);
        }

        .lobby-btn.primary {
            background: linear-gradient(180deg, #d97706 0%, #92400e 100%);
            color: #fef3c7;
            box-shadow: 0 4px 0 #451a03;
        }

        .lobby-btn.primary:active {
            box-shadow: 0 0 0 #451a03;
        }

        .lobby-btn.secondary {
            background: linear-gradient(180deg, #57534e 0%, #44403c 100%);
            color: #fef3c7;
            box-shadow: 0 4px 0 #292524;
        }

        /* ê²°ê³¼ í™”ë©´ */
        .result-screen {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 300;
            padding: 24px;
        }

        .result-screen.active {
            display: flex;
        }

        .result-content {
            background: linear-gradient(180deg, rgba(20, 15, 10, 0.9), rgba(20, 15, 10, 0.95)),
                        url('../img/modal1.png') center/cover;
            border: 2px solid #78350f;
            border-radius: 20px;
            padding: 24px;
            width: 100%;
            max-width: 360px;
            text-align: center;
        }

        .result-title {
            font-family: 'Nanum Brush Script', cursive;
            font-size: 36px;
            color: #f59e0b;
            text-shadow: 0 0 20px rgba(251, 191, 36, 1);
            margin-bottom: 20px;
        }
    </style>
</head>
<body class="portrait-only">
    <!-- ê°€ë¡œ ëª¨ë“œ ê²½ê³  -->
    <div class="landscape-warning">
        <div class="landscape-warning-icon">ğŸ“±</div>
        <div class="landscape-warning-text">ì„¸ë¡œ ëª¨ë“œë¡œ í”Œë ˆì´í•´ì£¼ì„¸ìš”</div>
    </div>

    <div class="mobile-container">
        <!-- ë¡œë¹„ í™”ë©´ -->
        <div id="lobby-screen" class="lobby-screen">
            <div class="lobby-content">
                <h2 class="lobby-title">ìˆ˜ë ¨ ëŒ€ê¸°ì‹¤</h2>
                <div class="lobby-info">
                    <div class="info-row">
                        <span class="info-label">ğŸ‘¤ ìˆ˜ë ¨ìƒ</span>
                        <span id="lobby-username" class="info-value" style="color: #fbbf24;">ìˆ˜ë ¨ ëŒ€ì›</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ğŸ’ ëˆ„ì  ë§ˆë ¥</span>
                        <span id="lobby-score" class="info-value" style="color: #f97316;">0</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ğŸ† ìµœê³  ë‹¨ê³„</span>
                        <span id="lobby-level" class="info-value" style="color: #ef4444;">Stage 1</span>
                    </div>
                </div>
                <div class="lobby-buttons">
                    <button id="btn-continue" class="lobby-btn primary">
                        ì´ì–´í•˜ê¸° <span id="continue-stage">(Stage 1)</span>
                    </button>
                    <button id="btn-new" class="lobby-btn secondary">
                        ì²˜ìŒë¶€í„°
                    </button>
                    <button id="btn-back" class="lobby-btn secondary" style="background: linear-gradient(180deg, #6b7280 0%, #4b5563 100%); border-color: #9ca3af;">
                        ëŒì•„ê°€ê¸°
                    </button>
                </div>
            </div>
        </div>

        <!-- ê²Œì„ í™”ë©´ -->
        <div id="game-container" class="game-container" style="display: none;">
            <!-- ìƒë‹¨ í—¤ë” -->
            <div class="game-header">
                <button id="btn-exit" class="back-button">âœ•</button>
                <div class="stage-title">Stage <span id="cur-stage">1</span></div>
                <div class="score-display">ğŸ’ <span id="cur-score">0</span></div>
            </div>

            <!-- ë§ˆë ¥ ê²Œì´ì§€ -->
            <div class="gauge-container">
                <div class="gauge-wrap">
                    <div id="time-bar" class="gauge-fill"></div>
                </div>
            </div>

            <!-- ì½¤ë³´ í‘œì‹œ -->
            <div class="combo-display">
                <span id="combo-text" class="combo-text"></span>
            </div>

            <!-- ì¹´ë“œ ê·¸ë¦¬ë“œ -->
            <div class="grid-area">
                <div id="card-grid" class="card-grid"></div>
            </div>
        </div>

        <!-- ë§ˆë²• ì˜¤ë²„ë ˆì´ -->
        <div id="magic-overlay" class="magic-overlay">
            <div id="magic-char" class="magic-char"></div>
            <div id="magic-desc" class="magic-desc"></div>
        </div>

        <!-- ê²°ê³¼ í™”ë©´ -->
        <div id="result-screen" class="result-screen">
            <div class="result-content">
                <h2 class="result-title">ìˆ˜ë ¨ ì¢…ë£Œ</h2>
                <div class="lobby-info">
                    <div class="info-row">
                        <span class="info-label">ğŸ’ ì–»ì€ ë§ˆë ¥</span>
                        <span id="result-score" class="info-value" style="color: #f97316;">0</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ğŸ† ë„ë‹¬ ë‹¨ê³„</span>
                        <span id="result-stage" class="info-value" style="color: #ef4444;">Stage 1</span>
                    </div>
                </div>
                <div class="lobby-buttons">
                    <button id="btn-save" class="lobby-btn primary">ê¸°ë¡ ì €ì¥</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // í•œì ë°ì´í„°
        const hanjas = [
            {id:1, c:"ä¸€", m:"í•œ", s:"ì¼"},
            {id:2, c:"äºŒ", m:"ë‘", s:"ì´"},
            {id:3, c:"ä¸‰", m:"ì„", s:"ì‚¼"},
            {id:4, c:"å››", m:"ë„‰", s:"ì‚¬"},
            {id:5, c:"äº”", m:"ë‹¤ì„¯", s:"ì˜¤"},
            {id:6, c:"å…­", m:"ì—¬ì„¯", s:"ìœ¡"},
            {id:7, c:"ä¸ƒ", m:"ì¼ê³±", s:"ì¹ "},
            {id:8, c:"å…«", m:"ì—¬ëŸ", s:"íŒ”"},
            {id:9, c:"ä¹", m:"ì•„í™‰", s:"êµ¬"},
            {id:10, c:"å", m:"ì—´", s:"ì‹­"},
            {id:11, c:"æ—¥", m:"ë‚ ", s:"ì¼"},
            {id:12, c:"æœˆ", m:"ë‹¬", s:"ì›”"},
            {id:13, c:"ç«", m:"ë¶ˆ", s:"í™”"},
            {id:14, c:"æ°´", m:"ë¬¼", s:"ìˆ˜"},
            {id:15, c:"æœ¨", m:"ë‚˜ë¬´", s:"ëª©"},
            {id:16, c:"é‡‘", m:"ì‡ ", s:"ê¸ˆ"},
            {id:17, c:"åœŸ", m:"í™", s:"í† "},
            {id:18, c:"å¤§", m:"í°", s:"ëŒ€"},
            {id:19, c:"å°", m:"ì‘ì„", s:"ì†Œ"},
            {id:20, c:"ä¸­", m:"ê°€ìš´ë°", s:"ì¤‘"},
            {id:21, c:"é•·", m:"ê¸¸", s:"ì¥"},
            {id:22, c:"å±±", m:"ë«¼", s:"ì‚°"},
            {id:23, c:"é–€", m:"ë¬¸", s:"ë¬¸"},
            {id:24, c:"æ±", m:"ë™ë…˜", s:"ë™"},
            {id:25, c:"è¥¿", m:"ì„œë…˜", s:"ì„œ"},
            {id:26, c:"å—", m:"ë‚¨ë…˜", s:"ë‚¨"},
            {id:27, c:"åŒ—", m:"ë¶ë…˜", s:"ë¶"},
            {id:28, c:"å¤–", m:"ë°”ê¹¥", s:"ì™¸"},
            {id:29, c:"å®¤", m:"ì§‘", s:"ì‹¤"},
            {id:30, c:"äºº", m:"ì‚¬ëŒ", s:"ì¸"},
            {id:31, c:"å¥³", m:"ì—¬ì", s:"ë…€"},
            {id:32, c:"çˆ¶", m:"ì•„ë²„ì§€", s:"ë¶€"},
            {id:33, c:"æ¯", m:"ì–´ë¨¸ë‹ˆ", s:"ëª¨"},
            {id:34, c:"å…„", m:"í˜•", s:"í˜•"},
            {id:35, c:"å¼Ÿ", m:"ì•„ìš°", s:"ì œ"},
            {id:36, c:"ç‹", m:"ì„ê¸ˆ", s:"ì™•"},
            {id:37, c:"æ°‘", m:"ë°±ì„±", s:"ë¯¼"},
            {id:38, c:"è»", m:"êµ°ì‚¬", s:"êµ°"},
            {id:39, c:"åœ‹", m:"ë‚˜ë¼", s:"êµ­"},
            {id:40, c:"æ ¡", m:"í•™êµ", s:"êµ"},
            {id:41, c:"å­¸", m:"ë°°ìš¸", s:"í•™"},
            {id:42, c:"æ•", m:"ê°€ë¥´ì¹ ", s:"êµ"},
            {id:43, c:"ç”Ÿ", m:"ë‚ ", s:"ìƒ"},
            {id:44, c:"ç™½", m:"í°", s:"ë°±"},
            {id:45, c:"é‘", m:"í‘¸ë¥¼", s:"ì²­"},
            {id:46, c:"å¹´", m:"í•´", s:"ë…„"},
            {id:47, c:"å…ˆ", m:"ë¨¼ì €", s:"ì„ "},
            {id:48, c:"è¬", m:"ì¼ë§Œ", s:"ë§Œ"},
            {id:49, c:"å¯¸", m:"ë§ˆë””", s:"ì´Œ"},
            {id:50, c:"éŸ“", m:"ë‚˜ë¼ì´ë¦„", s:"í•œ"}
        ];

        // ëª¨ë°”ì¼ìš© ìŠ¤í…Œì´ì§€ ë ˆì´ì•„ì›ƒ (4ì—´ ê³ ì •, í–‰ë§Œ ì¦ê°€)
        const stageLayouts = [
            { r: 2, c: 2 },  // Stage 1:  4ì¥
            { r: 2, c: 3 },  // Stage 2:  6ì¥
            { r: 2, c: 4 },  // Stage 3:  8ì¥
            { r: 3, c: 4 },  // Stage 4:  12ì¥
            { r: 4, c: 4 },  // Stage 5:  16ì¥
            { r: 5, c: 4 },  // Stage 6:  20ì¥
            { r: 6, c: 4 },  // Stage 7:  24ì¥
            { r: 7, c: 4 },  // Stage 8:  28ì¥
            { r: 8, c: 4 },  // Stage 9:  32ì¥
            { r: 9, c: 4 },  // Stage 10: 36ì¥
            { r: 10, c: 4 }, // Stage 11: 40ì¥
            { r: 10, c: 4 }, // Stage 12: 40ì¥
        ];

        // ê²Œì„ ìƒíƒœ
        let stage = 1;
        let total = 0;
        let stageScore = 0;
        let timeRemaining = 0;
        let active = false;
        let timer = null;
        let flippedCards = [];
        let matchedCount = 0;
        let combo = 0;
        const storageKey = 'hanjaGameData:mobile';

        // DOM ìš”ì†Œ
        const lobbyScreen = document.getElementById('lobby-screen');
        const gameContainer = document.getElementById('game-container');
        const resultScreen = document.getElementById('result-screen');
        const magicOverlay = document.getElementById('magic-overlay');
        const cardGrid = document.getElementById('card-grid');
        const timeBar = document.getElementById('time-bar');
        const comboText = document.getElementById('combo-text');

        // ì§„í–‰ ìƒí™© ë¶ˆëŸ¬ì˜¤ê¸°
        function loadProgress() {
            try {
                return JSON.parse(localStorage.getItem(storageKey) || '{"score":0,"level":1}');
            } catch {
                return { score: 0, level: 1 };
            }
        }

        // ì§„í–‰ ìƒí™© ì €ì¥
        function saveProgress(nextLevel) {
            const level = Math.min(Math.max(1, nextLevel), stageLayouts.length);
            localStorage.setItem(storageKey, JSON.stringify({
                score: total + stageScore,
                level
            }));
        }

        // ë¡œë¹„ ì´ˆê¸°í™”
        function initLobby() {
            const data = loadProgress();
            total = data.score || 0;
            stage = data.level || 1;

            const storedId = localStorage.getItem('mobileCurrentUserId');
            document.getElementById('lobby-username').textContent = storedId || 'ìˆ˜ë ¨ ëŒ€ì›';
            document.getElementById('lobby-score').textContent = total;
            document.getElementById('lobby-level').textContent = `Stage ${stage}`;
            document.getElementById('continue-stage').textContent = `(Stage ${stage})`;
        }

        // ì ìˆ˜ ì—…ë°ì´íŠ¸
        function updateScore() {
            document.getElementById('cur-score').textContent = total + stageScore;
        }

        // ê²Œì„ ì‹œì‘
        function startGame(fromBeginning = false) {
            if (fromBeginning) {
                stage = 1;
            }
            lobbyScreen.classList.add('hidden');
            gameContainer.style.display = 'flex';
            stageScore = 0;
            initStage();
        }

        // ìŠ¤í…Œì´ì§€ ì´ˆê¸°í™”
        function initStage() {
            active = true;
            flippedCards = [];
            matchedCount = 0;
            combo = 0;
            comboText.textContent = '';

            document.getElementById('cur-stage').textContent = stage;
            updateScore();

            if (stage > stageLayouts.length) {
                endGame();
                return;
            }

            const layout = stageLayouts[stage - 1];
            const r = layout.r;
            const c = layout.c;
            const pairs = (r * c) / 2;

            // í•´ê¸ˆëœ í•œì ìˆ˜ ê³„ì‚°
            const progress = Math.min(1, (stage + 5) / 16);
            const unlockCount = Math.max(pairs, Math.ceil(progress * hanjas.length));
            const pool = hanjas.slice(0, unlockCount);
            const shuffled = [...pool].sort(() => Math.random() - 0.5).slice(0, pairs);

            // ì¹´ë“œ ìƒì„±
            let cards = [];
            shuffled.forEach(h => {
                cards.push({ ...h, type: 'c', t: h.c });
                cards.push({ ...h, type: 's', t: `${h.m}\n[${h.s}]` });
            });
            cards.sort(() => Math.random() - 0.5);

            // ê·¸ë¦¬ë“œ ì„¤ì •
            cardGrid.innerHTML = '';
            cardGrid.style.gridTemplateColumns = `repeat(${c}, 1fr)`;

            // ì¹´ë“œ ë Œë”ë§
            cards.forEach(d => {
                const container = document.createElement('div');
                container.className = 'card-container';

                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.id = d.id;
                card.dataset.type = d.type;

                const front = document.createElement('div');
                front.className = 'card-face card-front';
                front.innerHTML = `<div class="${d.type === 'c' ? 'hanja-char' : 'hanja-meaning'}">${d.t}</div>`;

                const back = document.createElement('div');
                back.className = 'card-face card-back';

                card.appendChild(front);
                card.appendChild(back);
                container.appendChild(card);

                container.addEventListener('click', () => flip(card, d));
                cardGrid.appendChild(container);
            });

            // íƒ€ì´ë¨¸ ì‹œì‘
            timeRemaining = pairs * 10;
            if (timer) clearInterval(timer);
            const totalTime = timeRemaining;

            timer = setInterval(() => {
                timeRemaining -= 0.1;
                timeBar.style.width = (timeRemaining / totalTime * 100) + '%';
                if (timeRemaining <= 0) endGame();
            }, 100);
        }

        // ì¹´ë“œ ë’¤ì§‘ê¸°
        function flip(el, d) {
            if (!active || flippedCards.length >= 2) return;
            if (el.classList.contains('flipped') || el.classList.contains('matched')) return;

            unlockTTS();
            el.classList.add('flipped');
            flippedCards.push({ el, d });

            if (flippedCards.length === 2) {
                check();
            }
        }

        // ë§¤ì¹­ í™•ì¸
        function check() {
            const [a, b] = flippedCards;

            if (a.d.id === b.d.id && a.d.type !== b.d.type) {
                // ë§¤ì¹­ ì„±ê³µ
                stageScore += 10;
                matchedCount += 2;
                combo++;
                updateScore();
                timeRemaining = Math.min(timeRemaining + 3, 150);

                showMagic(a.d);

                if (combo >= 3) {
                    triggerHint();
                }

                setTimeout(() => {
                    a.el.classList.add('matched');
                    b.el.classList.add('matched');
                    flippedCards = [];

                    if (matchedCount === document.querySelectorAll('.card').length) {
                        clearInterval(timer);
                        if (stage >= stageLayouts.length) {
                            saveProgress(stage);
                            endGame();
                        } else {
                            saveProgress(stage + 1);
                            stage++;
                            setTimeout(initStage, 600);
                        }
                    }
                }, 500);
            } else {
                // ë§¤ì¹­ ì‹¤íŒ¨
                combo = 0;
                timeRemaining -= 2;
                comboText.textContent = '';

                setTimeout(() => {
                    a.el.classList.remove('flipped');
                    b.el.classList.remove('flipped');
                    flippedCards = [];
                }, 500);
            }
        }

        // íŒíŠ¸ ë°œë™ (3ì½¤ë³´ ì´ìƒ)
        function triggerHint() {
            comboText.textContent = `${combo} ì½¤ë³´!`;
            speak("íŒíŠ¸ ë§ˆë²•!");

            const unmatched = Array.from(document.querySelectorAll('.card:not(.matched):not(.flipped)'));
            if (unmatched.length >= 2) {
                const id = unmatched[0].dataset.id;
                const pair = unmatched.filter(c => c.dataset.id === id);
                pair.forEach(c => c.classList.add('flipped'));
                setTimeout(() => {
                    pair.forEach(c => {
                        if (!c.classList.contains('matched')) {
                            c.classList.remove('flipped');
                        }
                    });
                }, 600);
            }
        }

        // ë§ˆë²• íš¨ê³¼ í‘œì‹œ
        function showMagic(d) {
            document.getElementById('magic-char').textContent = d.c;
            document.getElementById('magic-desc').textContent = `${d.m} ${d.s}`;
            magicOverlay.classList.add('active');
            speak(`${d.m} ${d.s}`);

            setTimeout(() => {
                magicOverlay.classList.remove('active');
            }, 700);
        }

        // ê²Œì„ ì¢…ë£Œ
        function endGame() {
            active = false;
            if (timer) clearInterval(timer);

            speak("ìˆ˜ë ¨ ì‹œê°„ì´ ëë‚¬ë‹¤!");

            document.getElementById('result-score').textContent = stageScore;
            document.getElementById('result-stage').textContent = `Stage ${stage}`;
            resultScreen.classList.add('active');
            gameContainer.style.display = 'none';
        }

        // ê²Œì„ ì¢…ë£Œ ë° ì €ì¥
        function finishGame() {
            total += stageScore;
            localStorage.setItem(storageKey, JSON.stringify({ score: total, level: stage }));

            // ëª¨ë°”ì¼ ë©”ì¸ìœ¼ë¡œ ìŠ¤í…Œì´ì§€ ì™„ë£Œ ì•Œë¦¼
            const mobileState = JSON.parse(localStorage.getItem('mobileGameState') || '{}');
            mobileState.stage1Completed = true;
            localStorage.setItem('mobileGameState', JSON.stringify(mobileState));

            setReturnToVillageAfterBori();
            window.location.href = 'index.html';
        }

        let ttsUnlocked = false;
        function getKoreanVoice() {
            const voices = window.speechSynthesis ? window.speechSynthesis.getVoices() : [];
            return voices.find(v => v.lang === 'ko-KR') || voices.find(v => v.lang.startsWith('ko')) || null;
        }

        function unlockTTS() {
            if (!('speechSynthesis' in window) || ttsUnlocked) return;
            ttsUnlocked = true;
            const u = new SpeechSynthesisUtterance(' ');
            u.lang = 'ko-KR';
            u.volume = 0;
            window.speechSynthesis.speak(u);
            window.speechSynthesis.cancel();
        }

        // TTS
        function speak(text) {
            if ('speechSynthesis' in window) {
                unlockTTS();
                window.speechSynthesis.resume();
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                const voice = getKoreanVoice();
                if (voice) utterance.voice = voice;
                utterance.lang = 'ko-KR';
                utterance.rate = 1.2;
                window.speechSynthesis.speak(utterance);
            }
        }

        function setReturnToVillageAfterBori() {
            const mobileState = JSON.parse(localStorage.getItem('mobileGameState') || '{}');
            mobileState.returnAfterBori = true;
            localStorage.setItem('mobileGameState', JSON.stringify(mobileState));
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('btn-continue').addEventListener('click', () => startGame(false));
        document.getElementById('btn-new').addEventListener('click', () => startGame(true));
        document.getElementById('btn-back').addEventListener('click', () => {
            setReturnToVillageAfterBori();
            window.location.href = 'index.html';
        });
        document.getElementById('btn-exit').addEventListener('click', () => {
            if (confirm('ì •ë§ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ? ì§„í–‰ ì¤‘ì¸ ë‚´ìš©ì´ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.')) {
                if (timer) clearInterval(timer);
                setReturnToVillageAfterBori();
                window.location.href = 'index.html';
            }
        });
        document.getElementById('btn-save').addEventListener('click', finishGame);

        // ì´ˆê¸°í™”
        initLobby();
        document.addEventListener('pointerdown', unlockTTS, { once: true });
        speak("ìˆ˜ë ¨ì¥ì— ì˜ ì™”ë‹¤! ì¤€ë¹„ëìœ¼ë©´ ì‹œì‘í•´ë³¼ê¹Œ?");
    </script>
</body>
</html>
